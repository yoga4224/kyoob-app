/*******************
VARIABLES
*******************/
var expandButton;
var closeAdButton;
var expanded_already;
var scrolltime = 0;
var triggerlimit = false;
/*******************
INITIALIZATION
*******************/
function checkIfEBInitialized(event)
{
	if(!EB.isInitialized())
	{
		EB.addEventListener(EBG.EventName.EB_INITIALIZED, initializeCreative);
	}
	else
	{
		initializeCreative();
	}
}

function initializeCreative()
{
	initializeGlobalVariables();
	addEventListeners();
    EB._sendMessage("sayhello", {});

}


function initializeGlobalVariables()
{
    expanded_already = false;
	expandButton = document.getElementById("expand-button");
	closeAdButton = document.getElementById("close-ad-button");
}

function addEventListeners()
{
	expandButton.addEventListener("click", expand);
	closeAdButton.addEventListener("click", closeAd);
}

/*******************
EVENT HANDLERS
*******************/
function expand()
{
	EB.expand({panelName: (EB._adConfig && EB._adConfig.hasOwnProperty("mdExpandPanelName") ? EB._adConfig.mdExpandPanelName : "expand")});
}

function youcallme(){
    EB.expand({panelName: (EB._adConfig && EB._adConfig.hasOwnProperty("mdExpandPanelName") ? EB._adConfig.mdExpandPanelName : "expand")}); 	
    //window.removeEventListener("DOMContentLoaded", message, false);
    console.log("Remove the listener");
}

function closeAd()
{
	EB.userActionCounter("closeAd");
	EB._sendMessage("closeAd", {});
}

var scrolllist = function(){
    if(triggerlimit == false){
                try{
                    var data = JSON.parse(event.data);
                    if(data.type == "VISIBILITY_CHECK"){
                        if (scrolltime>100){
                            if (!expanded_already){    
                                youcallme();
                                expanded_already = true;
                                window.removeEventListener("message", scrolllist, false);
                            }
                        triggerlimit = true;
                    }
                     scrolltime = scrolltime+1;
                     //console.log("Hello from " +scrolltime);
                    }
                } catch (error) {
                    //console.log("error");
                }
        }
}
/*
function receiveMessage(event)
{
  // Do we trust the sender of this message?  (might be
  // different from what we originally opened, for example).
  //if (event.origin !== "http://example.org")
//    return;
    console.log('Recieved Message from Custom script');
  // event.source is popup
  // event.data is "hi there yourself!  the secret response is: rheeeeet!"
}
window.addEventListener("message", receiveMessage, false);
*/

window.addEventListener("DOMContentLoaded", checkIfEBInitialized, false);





window.addEventListener("message", scrolllist, false);

